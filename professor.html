<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sistema Escolar ‚Ä¢ SMA</title>
  <style>
    :root {
      --bg: #0b1225;
      --fg: #f5f7fa;
      --muted: #9aa4b8;
      --brand: #2e8b57;
      --brand-2: #3fa76d;
      --tile-bg: #121c35;
      --tile-border: #1f2a4d;
      --radius: 18px;
      --shadow: 0 8px 22px -12px rgba(0, 0, 0, 0.6);
      --focus: 0 0 0 3px rgba(46, 139, 87, 0.35);
      --sidebar-width: 280px;
      --sidebar-collapsed: 70px;
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg);
      color: var(--fg);
      min-height: 100vh;
      display: flex;
    }
    
    /* SIDEBAR */
    .sidebar {
      width: var(--sidebar-width);
      background: var(--tile-bg);
      border-right: 1px solid var(--tile-border);
      display: flex;
      flex-direction: column;
      position: fixed;
      left: 0;
      top: 0;
      bottom: 0;
      z-index: 100;
      transition: width 0.3s ease, transform 0.3s ease;
      overflow-x: hidden;
      overflow-y: auto;
    }
    
    .sidebar.collapsed {
      width: var(--sidebar-collapsed);
    }
    
    .sidebar-header {
      padding: 24px 20px;
      border-bottom: 1px solid var(--tile-border);
      display: flex;
      align-items: center;
      gap: 12px;
      min-height: 80px;
    }
    
    .logo-icon {
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, var(--brand), var(--brand-2));
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 900;
      font-size: 18px;
      flex-shrink: 0;
    }
    
    .logo-text {
      font-weight: 700;
      font-size: 16px;
      white-space: nowrap;
      opacity: 1;
      transition: opacity 0.2s;
    }
    
    .sidebar.collapsed .logo-text {
      opacity: 0;
      width: 0;
    }
    
    .school-badge {
      background: rgba(46, 139, 87, 0.15);
      color: var(--brand-2);
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      white-space: nowrap;
      margin: 8px 20px;
      text-align: center;
      opacity: 1;
      transition: opacity 0.2s;
    }
    
    .sidebar.collapsed .school-badge {
      opacity: 0;
      height: 0;
      margin: 0;
      padding: 0;
    }
    
    .nav-section {
      padding: 8px;
      flex: 1;
    }
    
    .nav-item {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 12px 16px;
      margin: 4px 0;
      border-radius: 12px;
      color: var(--muted);
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
      background: transparent;
      width: 100%;
      font-size: 14px;
      text-align: left;
      white-space: nowrap;
    }
    
    .nav-item:hover {
      background: rgba(46, 139, 87, 0.1);
      color: var(--fg);
    }
    
    .nav-item.active {
      background: linear-gradient(135deg, rgba(46, 139, 87, 0.2), rgba(63, 167, 109, 0.15));
      color: var(--brand-2);
      font-weight: 600;
    }
    
    .nav-item-icon {
      font-size: 20px;
      flex-shrink: 0;
      width: 24px;
      text-align: center;
    }
    
    .nav-item-text {
      opacity: 1;
      transition: opacity 0.2s;
    }
    
    .sidebar.collapsed .nav-item-text {
      opacity: 0;
      width: 0;
    }
    
    .sidebar-footer {
      padding: 16px;
      border-top: 1px solid var(--tile-border);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px;
      background: rgba(46, 139, 87, 0.08);
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .user-info:hover {
      background: rgba(46, 139, 87, 0.15);
    }
    
    .user-avatar {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, var(--brand), var(--brand-2));
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 14px;
      flex-shrink: 0;
    }
    
    .user-details {
      flex: 1;
      min-width: 0;
      opacity: 1;
      transition: opacity 0.2s;
    }
    
    .sidebar.collapsed .user-details {
      opacity: 0;
      width: 0;
    }
    
    .user-name {
      font-size: 13px;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .user-role {
      font-size: 11px;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .action-buttons {
      display: flex;
      gap: 8px;
      opacity: 1;
      transition: opacity 0.2s;
    }
    
    .sidebar.collapsed .action-buttons {
      opacity: 0;
      height: 0;
      overflow: hidden;
    }
    
    .btn {
      padding: 8px 14px;
      border: 1px solid var(--tile-border);
      background: var(--tile-bg);
      color: var(--fg);
      border-radius: 8px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }
    
    .btn:hover {
      background: var(--tile-border);
      transform: translateY(-1px);
    }
    
    .btn.primary {
      background: linear-gradient(135deg, var(--brand), var(--brand-2));
      border: none;
      color: white;
    }
    
    .btn.danger {
      background: linear-gradient(135deg, #dc2626, #b91c1c);
      border: none;
      color: white;
    }
    
    .toggle-sidebar {
      position: absolute;
      top: 28px;
      right: -14px;
      width: 28px;
      height: 28px;
      background: var(--tile-bg);
      border: 1px solid var(--tile-border);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 14px;
      z-index: 101;
    }
    
    .toggle-sidebar:hover {
      background: var(--brand);
      border-color: var(--brand);
      color: white;
    }
    
    /* MAIN CONTENT */
    .main-content {
      margin-left: var(--sidebar-width);
      flex: 1;
      padding: 32px;
      transition: margin-left 0.3s ease;
      min-height: 100vh;
    }
    
    .sidebar.collapsed ~ .main-content {
      margin-left: var(--sidebar-collapsed);
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    /* CARDS & GRID */
    .card {
      background: var(--tile-bg);
      border: 1px solid var(--tile-border);
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: var(--shadow);
    }
    
    .card h3 {
      font-size: 18px;
      margin-bottom: 16px;
      color: var(--fg);
    }
    
    .grid {
      display: grid;
      gap: 20px;
    }
    
    .grid-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    .grid-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
    .grid-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); }
    
    .kpi {
      text-align: center;
      padding: 20px;
    }
    
    .kpi .num {
      font-size: 36px;
      font-weight: 800;
      background: linear-gradient(135deg, var(--brand), var(--brand-2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .kpi .label {
      color: var(--muted);
      font-size: 13px;
      margin-top: 8px;
    }
    
    .view-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 16px;
      margin-bottom: 24px;
    }
    
    .view-title {
      font-size: 28px;
      font-weight: 700;
    }
    
    .view-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    /* TABLE */
    .table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .table th,
    .table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid var(--tile-border);
    }
    
    .table th {
      color: var(--muted);
      font-weight: 600;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .table td {
      color: var(--fg);
    }
    
    .table tr:hover {
      background: rgba(46, 139, 87, 0.05);
    }
    
    /* FORMS */
    .input, select, textarea {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid var(--tile-border);
      border-radius: 10px;
      background: var(--bg);
      color: var(--fg);
      font-size: 14px;
      transition: all 0.2s;
    }
    
    .input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--brand);
      box-shadow: var(--focus);
    }
    
    label {
      display: block;
      margin-bottom: 6px;
      font-size: 13px;
      font-weight: 500;
      color: var(--muted);
    }
    
    /* UTILITIES */
    .row {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .row.wrap { flex-wrap: wrap; }
    .row.between { justify-content: space-between; }
    
    .muted { color: var(--muted); }
    .hidden { display: none !important; }
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0,0,0,0);
      white-space: nowrap;
      border: 0;
    }
    
    .badge {
      padding: 4px 10px;
      border-radius: 6px;
      border: 1px solid var(--tile-border);
      font-size: 12px;
      color: var(--muted);
      display: inline-block;
    }
    
    /* LOGIN */
    .login-wrapper {
      display: grid;
      place-items: center;
      min-height: 100vh;
      width: 100%;
      padding: 20px;
    }
    
    .login-card {
      width: min(480px, 95vw);
    }
    
    .logo-login {
      text-align: center;
      font-size: 32px;
      font-weight: 900;
      margin-bottom: 8px;
      background: linear-gradient(135deg, var(--brand), var(--brand-2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    /* RESPONSIVE */
    @media (max-width: 1024px) {
      .grid-3, .grid-4 { grid-template-columns: repeat(2, 1fr); }
    }
    
    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
        width: var(--sidebar-width);
      }
      
      .sidebar.open {
        transform: translateX(0);
      }
      
      .sidebar.collapsed {
        transform: translateX(-100%);
      }
      
      .main-content {
        margin-left: 0;
      }
      
      .sidebar.collapsed ~ .main-content {
        margin-left: 0;
      }
      
      .mobile-menu-btn {
        position: fixed;
        top: 20px;
        left: 20px;
        width: 44px;
        height: 44px;
        background: var(--tile-bg);
        border: 1px solid var(--tile-border);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 99;
        font-size: 20px;
      }
      
      .sidebar-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 99;
      }
      
      .sidebar.open ~ .sidebar-overlay {
        display: block;
      }
      
      .toggle-sidebar {
        display: none;
      }
      
      .grid-2, .grid-3, .grid-4 {
        grid-template-columns: 1fr;
      }
      
      .main-content {
        padding: 20px;
      }
      
      .view-header {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <!-- MOBILE MENU BUTTON -->
  <button class="mobile-menu-btn" id="mobileMenuBtn" style="display: none;">‚ò∞</button>
  
  <!-- LOGIN -->
  <section id="login" class="login-wrapper">
    <div class="card login-card">
      <div class="logo-login">Centro Escolar</div>
      <div style="text-align: center; margin-bottom: 24px;">
        <span class="badge">Painel Administrativo v1.0</span>
      </div>
      <p class="muted" style="margin-bottom: 20px; text-align: center;">
        Acesse com seu e-mail e senha. Primeiro acesso: <code>admin@escola</code> / <code>123</code>
      </p>
      <div class="grid" style="gap: 16px;">
        <div>
          <label>Email</label>
          <input class="input" id="loginEmail" autocomplete="username" placeholder="seu@email"/>
        </div>
        <div>
          <label>Senha</label>
          <input class="input" id="loginPass" type="password" autocomplete="current-password"/>
        </div>
        <div class="row" style="gap: 12px;">
          <button class="btn primary" id="btnLogin" style="flex: 1;">Entrar</button>
          <button class="btn" id="btnSeed">Recriar dados</button>
        </div>
      </div>
      <p class="muted" style="margin-top: 16px; font-size: 12px; text-align: center;">
        Caso n√£o tenha acesso procure a secret√°ria da escola.
      </p>
    </div>
  </section>

  <!-- APP -->
  <section id="app" class="hidden">
    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
      <button class="toggle-sidebar" id="toggleSidebar">‚Äπ</button>
      
      <div class="sidebar-header">
        <div class="logo-icon">CE</div>
        <div class="logo-text">Centro Escolar</div>
      </div>
      
      <div class="school-badge" id="schoolName">Escola Estadual</div>
      
      <nav class="nav-section" id="navSection">
        <!-- Navigation items will be inserted here -->
      </nav>
      
      <div class="sidebar-footer">
        <div class="user-info">
          <div class="user-avatar" id="userAvatar">A</div>
          <div class="user-details">
            <div class="user-name" id="userName">Admin</div>
            <div class="user-role" id="userRole">admin</div>
          </div>
        </div>
        <div class="action-buttons">
          <button class="btn" id="btnExport" style="flex: 1;">üíæ Exportar</button>
          <label class="btn" style="flex: 1;">
            üìÅ Importar
            <input id="importFile" type="file" accept="application/json" class="sr-only"/>
          </label>
        </div>
        <button class="btn danger" id="btnLogout" style="width: 100%;">üö™ Sair</button>
      </div>
    </aside>
    
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- MAIN CONTENT -->
    <main class="main-content">
      <div class="container">
        <div class="view-header">
          <h1 class="view-title" id="viewTitle">In√≠cio</h1>
          <div class="view-actions" id="viewActions"></div>
        </div>
        
        <!-- KPIs -->
        <div class="grid grid-4" id="kpis" style="margin-bottom: 24px;"></div>
        
        <!-- View Body -->
        <div id="viewBody"></div>
      </div>
    </main>
  </section>

  <script>
// ===== UTIL & STORAGE =====================================================
const DB_KEY = 'sma_db_v1';
const nowISO = () => new Date().toISOString();
const fmtDate = (iso) => new Date(iso).toLocaleDateString('pt-BR');
const uid = (p='id') => p+'_'+Math.random().toString(36).slice(2,9);
const saveDB = (db) => localStorage.setItem(DB_KEY, JSON.stringify(db));
const loadDB = () => JSON.parse(localStorage.getItem(DB_KEY) || 'null');
const clone = (o)=> JSON.parse(JSON.stringify(o));
const toast = (msg)=> alert(msg);

const ROLES = {ADMIN:'admin', SECRETARIA:'secretaria', BIBLI:'biblioteca', PROF:'prof', ALUNO:'aluno'};

const seedDB = () => ({
  meta:{schoolName:'Escola Estadual de Exemplo'},
  users:[
    {id:uid('u'), email:'admin@escola', name:'Admin', role:ROLES.ADMIN, pass:'123'},
    {id:uid('u'), email:'secretaria@escola', name:'Secretaria', role:ROLES.SECRETARIA, pass:'123'},
    {id:uid('u'), email:'bibli@escola', name:'Biblioteca', role:ROLES.BIBLI, pass:'123'},
    {id:uid('u'), email:'prof@escola', name:'Prof. Jo√£o', role:ROLES.PROF, pass:'123'},
    {id:uid('u'), email:'aluno@escola', name:'Aluno Teste', role:ROLES.ALUNO, pass:'123'}
  ],
  alunos:[
    {id:uid('a'), nome:'Ana Lima', matricula:'2025A001', turma:'1¬∫A', turno:'Manh√£'},
    {id:uid('a'), nome:'Bruno Souza', matricula:'2025A002', turma:'1¬∫A', turno:'Manh√£'}
  ],
  professores:[{id:uid('p'), nome:'Jo√£o Silva', cpf:'000.000.000-00', area:'F√≠sica'}],
  turmas:[{id:uid('t'), nome:'1¬∫A', ano:2025, turno:'Manh√£'}],
  livros:[{id:uid('l'), isbn:'978857522', titulo:'F√≠sica B√°sica', autor:'Halliday', categoria:'F√≠sica', exemplares:3}],
  emprestimos:[],
  chamadas:[],
  protocolos:[],
  licencas:[],
  documentos:[],
  log:[]
});

function ensureDB(){
  let db = loadDB();
  if(!db){ db = seedDB(); saveDB(db); }
  return db;
}

const DB = { get: ensureDB, set: saveDB, reset(){ localStorage.removeItem(DB_KEY);} };

// ===== AUTH ===============================================================
let CURRENT_USER = null;
function login(email, pass){
  const db = DB.get();
  const u = db.users.find(x=>x.email===email && x.pass===pass);
  if(!u) return null;
  CURRENT_USER = {id:u.id, email:u.email, name:u.name, role:u.role};
  return CURRENT_USER;
}
function logout(){ CURRENT_USER=null; }

// ===== RENDERING ==========================================================
const el = (sel)=> document.querySelector(sel);
const viewBody = el('#viewBody');
const viewTitle = el('#viewTitle');
const viewActions = el('#viewActions');
const kpisEl = el('#kpis');
const navSection = el('#navSection');

const NAV_ITEMS = [
  {id:'viewDashboard', label:'In√≠cio', icon:'üè†', roles:'*'},
  {id:'viewAlunos', label:'Alunos', icon:'üë®üèª‚Äçüéì', roles:[ROLES.ADMIN, ROLES.SECRETARIA]},
  {id:'viewProfessores', label:'Professores', icon:'üë©üèª‚Äçüè´', roles:[ROLES.ADMIN, ROLES.SECRETARIA]},
  {id:'viewTurmas', label:'Turmas', icon:'üè∑Ô∏è', roles:[ROLES.ADMIN, ROLES.SECRETARIA]},
  {id:'viewChamada', label:'Chamada', icon:'üìã', roles:[ROLES.ADMIN, ROLES.SECRETARIA, ROLES.PROF]},
  {id:'viewBiblioteca', label:'Biblioteca', icon:'üìö', roles:[ROLES.ADMIN, ROLES.BIBLI, ROLES.SECRETARIA]},
  {id:'viewProtocolos', label:'Protocolos', icon:'üóÇÔ∏è', roles:[ROLES.ADMIN, ROLES.SECRETARIA]},
  {id:'viewLicencas', label:'Licen√ßas', icon:'üßæ', roles:[ROLES.ADMIN, ROLES.SECRETARIA]},
  {id:'viewConfig', label:'Configura√ß√µes', icon:'‚öôÔ∏è', roles:[ROLES.ADMIN]}
];

function renderNav(){
  navSection.innerHTML='';
  NAV_ITEMS.forEach(item=>{
    if(item.roles==='*' || item.roles.includes(CURRENT_USER.role)){
      const btn = document.createElement('button');
      btn.className='nav-item';
      btn.dataset.open=item.id;
      btn.innerHTML = `<span class="nav-item-icon">${item.icon}</span><span class="nav-item-text">${item.label}</span>`;
      navSection.appendChild(btn);
    }
  });
}

function renderKPIs(){
  const db = DB.get();
  const kpis = [
    {label:'Alunos', value: db.alunos.length},
    {label:'Professores', value: db.professores.length},
    {label:'Livros', value: db.livros.length},
    {label:'Empr√©stimos', value: db.emprestimos.filter(e=>!e.devolvidoEm).length}
  ];
  kpisEl.innerHTML='';
  kpis.forEach(k=>{
    const d = document.createElement('div');
    d.className='card kpi';
    d.innerHTML = `<div class="num">${k.value}</div><div class="label">${k.label}</div>`;
    kpisEl.appendChild(d);
  });
}

function setView(title, actionsHTML, bodyHTML){
  viewTitle.textContent = title;
  viewActions.innerHTML = actionsHTML || '';
  viewBody.innerHTML = bodyHTML || '';
  
  // Remove active class from all nav items
  document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
}

function setActiveNav(viewId) {
  document.querySelectorAll('.nav-item').forEach(item => {
    if(item.dataset.open === viewId) {
      item.classList.add('active');
    }
  });
}

// ===== TEMPLATES & VIEWS ==================================================
function tbl(rows){ return `<div class="card"><table class="table">${rows}</table></div>` }
function row(cells, th=false){ return `<tr>${cells.map(c=> th?`<th>${c}</th>`:`<td>${c}</td>`).join('')}</tr>` }

// Dashboard view
function viewDashboard(){
  const db = DB.get();
  const atrasos = db.emprestimos.filter(e=>!e.devolvidoEm && new Date(e.devolverAte) < new Date());
  setView('In√≠cio','',`
    <div class='grid grid-3'>
      <div class='card'>
        <h3>üìä Alertas</h3>
        <ul style="list-style: none; padding: 0; margin: 0;">
          <li style="padding: 8px 0; border-bottom: 1px solid var(--tile-border);">üìö Empr√©stimos atrasados: <b>${atrasos.length}</b></li>
          <li style="padding: 8px 0; border-bottom: 1px solid var(--tile-border);">üë• Alunos: <b>${db.alunos.length}</b> ‚Ä¢ Professores: <b>${db.professores.length}</b></li>
          <li style="padding: 8px 0;">üóÇÔ∏è Protocolos abertos: <b>${db.protocolos.filter(p=>p.status!=='Conclu√≠do' && p.status!=='Arquivado').length}</b></li>
        </ul>
      </div>
      <div class='card'>
        <h3>üöÄ Pr√≥ximos passos</h3>
        <p class='muted' style="margin-bottom: 16px;">Use o menu lateral para navegar.</p>
        <div class='row wrap' style="gap: 8px;">
          <button class='btn' data-open='viewBiblioteca'>üìö Biblioteca</button>
          <button class='btn' data-open='viewChamada'>üìã Chamada</button>
          <button class='btn' data-open='viewProtocolos'>üóÇÔ∏è Protocolos</button>
          <button class='btn' data-open='viewConfig'>‚öôÔ∏è Config</button>
        </div>
      </div>
      <div class='card'>
        <h3>üí° Dicas de uso</h3>
        <ol style="margin-left: 20px; color: var(--muted); font-size: 14px; line-height: 1.8;">
          <li>Troque a senha do admin em Configura√ß√µes</li>
          <li>Cadastre turmas, alunos e professores</li>
          <li>Registre empr√©stimos na Biblioteca</li>
          <li>Fa√ßa backup regularmente</li>
        </ol>
      </div>
    </div>
  `);
  setActiveNav('viewDashboard');
}

// Alunos
function viewAlunos(){
  const db = DB.get();
  const header = row(['Matr√≠cula','Nome','Turma','Turno','A√ß√µes'], true);
  const rows = db.alunos.map(a=> row([a.matricula, a.nome, a.turma, a.turno,
    `<div class='row' style="gap: 6px;"><button class='btn' data-editaluno='${a.id}'>Editar</button><button class='btn danger' data-rmaluno='${a.id}'>Excluir</button></div>`
  ]) ).join('');
  setView('Alunos', `<button class='btn primary' id='addAluno'>‚ûï Novo Aluno</button> <label class='btn'>üìÅ Importar CSV <input id='alunosCSV' type='file' accept='.csv' class='sr-only'></label>`, tbl(header+rows));
  setActiveNav('viewAlunos');
  const inp = document.getElementById('alunosCSV'); if(inp){ inp.onchange=(ev)=>importCSV(ev.target.files[0],'alunos'); }
}

function formAluno(a){
  const isNew = !a;
  a = a || {nome:'', matricula:'', turma:'', turno:'Manh√£'};
  setView(isNew?'Novo Aluno':'Editar Aluno','',`
    <div class='card'>
      <div class='grid grid-2'>
        <div><label>Matr√≠cula</label><input class='input' id='f_matricula' value='${a.matricula}'/></div>
        <div><label>Nome</label><input class='input' id='f_nome' value='${a.nome}'/></div>
        <div><label>Turma</label><input class='input' id='f_turma' value='${a.turma}'/></div>
        <div><label>Turno</label><select id='f_turno' class='input'>
          ${['Manh√£','Tarde','Noite'].map(t=>`<option ${a.turno===t?'selected':''}>${t}</option>`).join('')}
        </select></div>
      </div>
      <div class='row' style='margin-top:20px; gap: 12px;'>
        <button class='btn primary' id='saveAluno'>üíæ Salvar</button>
        <button class='btn' data-open='viewAlunos'>‚ùå Cancelar</button>
      </div>
    </div>
  `);
  document.querySelector('#saveAluno').onclick = ()=>{
    const db = DB.get();
    const rec = {id:a.id||uid('a'), nome:el('#f_nome').value.trim(), matricula:el('#f_matricula').value.trim(), turma:el('#f_turma').value.trim(), turno:el('#f_turno').value};
    if(!rec.nome||!rec.matricula) return toast('Preencha matr√≠cula e nome.');
    if(a.id){
      const i = db.alunos.findIndex(x=>x.id===a.id); db.alunos[i]=rec;
    }else{ db.alunos.push(rec); }
    DB.set(db); viewAlunos(); renderKPIs();
  };
}

// Professores
function viewProfessores(){
  const db = DB.get();
  const header = row(['Nome','CPF','√Årea','A√ß√µes'], true);
  const rows = db.professores.map(p=> row([p.nome, p.cpf, p.area,
    `<div class='row' style="gap: 6px;"><button class='btn' data-editprof='${p.id}'>Editar</button><button class='btn danger' data-rmprof='${p.id}'>Excluir</button></div>`
  ]) ).join('');
  setView('Professores', `<button class='btn primary' id='addProf'>‚ûï Novo Professor</button>`, tbl(header+rows));
  setActiveNav('viewProfessores');
}

function formProf(p){
  const isNew = !p; p = p || {nome:'', cpf:'', area:''};
  setView(isNew?'Novo Professor':'Editar Professor','',`
    <div class='card'>
      <div class='grid grid-3'>
        <div><label>Nome</label><input class='input' id='fp_nome' value='${p.nome}'/></div>
        <div><label>CPF</label><input class='input' id='fp_cpf' value='${p.cpf}'/></div>
        <div><label>√Årea</label><input class='input' id='fp_area' value='${p.area}'/></div>
      </div>
      <div class='row' style='margin-top:20px; gap: 12px;'>
        <button class='btn primary' id='saveProf'>üíæ Salvar</button>
        <button class='btn' data-open='viewProfessores'>‚ùå Cancelar</button>
      </div>
    </div>
  `);
  el('#saveProf').onclick = ()=>{
    const db = DB.get();
    const rec = {id:p.id||uid('p'), nome:el('#fp_nome').value.trim(), cpf:el('#fp_cpf').value.trim(), area:el('#fp_area').value.trim()};
    if(!rec.nome) return toast('Informe o nome.');
    if(p.id){ const i=db.professores.findIndex(x=>x.id===p.id); db.professores[i]=rec; }
    else db.professores.push(rec);
    DB.set(db); viewProfessores(); renderKPIs();
  };
}

// Turmas
function viewTurmas(){
  const db = DB.get();
  const header = row(['Nome','Ano','Turno','A√ß√µes'], true);
  const rows = db.turmas.map(t=> row([t.nome, t.ano, t.turno,
    `<div class='row' style="gap: 6px;"><button class='btn' data-editturma='${t.id}'>Editar</button><button class='btn danger' data-rmturma='${t.id}'>Excluir</button></div>`
  ]) ).join('');
  setView('Turmas', `<button class='btn primary' id='addTurma'>‚ûï Nova Turma</button>`, tbl(header+rows));
  setActiveNav('viewTurmas');
}

function formTurma(t){
  const isNew = !t; t = t || {nome:'', ano:new Date().getFullYear(), turno:'Manh√£'};
  setView(isNew?'Nova Turma':'Editar Turma','',`
    <div class='card'>
      <div class='grid grid-3'>
        <div><label>Nome</label><input class='input' id='ft_nome' value='${t.nome}'/></div>
        <div><label>Ano</label><input class='input' id='ft_ano' type='number' value='${t.ano}'/></div>
        <div><label>Turno</label><select id='ft_turno' class='input'>
          ${['Manh√£','Tarde','Noite'].map(x=>`<option ${t.turno===x?'selected':''}>${x}</option>`).join('')}
        </select></div>
      </div>
      <div class='row' style='margin-top:20px; gap: 12px;'>
        <button class='btn primary' id='saveTurma'>üíæ Salvar</button>
        <button class='btn' data-open='viewTurmas'>‚ùå Cancelar</button>
      </div>
    </div>
  `);
  el('#saveTurma').onclick = ()=>{
    const db = DB.get();
    const rec = {id:t.id||uid('t'), nome:el('#ft_nome').value.trim(), ano:parseInt(el('#ft_ano').value,10), turno:el('#ft_turno').value};
    if(!rec.nome) return toast('Informe o nome.');
    if(t.id){ const i=db.turmas.findIndex(x=>x.id===t.id); db.turmas[i]=rec; }
    else db.turmas.push(rec);
    DB.set(db); viewTurmas();
  };
}

// Chamada
function viewChamada(){
  const db = DB.get();
  const turmasOpts = db.turmas.map(t=>`<option value='${t.id}'>${t.nome} (${t.turno})</option>`).join('');
  setView('Chamada', `<button class='btn' id='btnHistoricoChamada'>üìä Hist√≥rico</button>`, `
    <div class='card'>
      <div class='grid grid-3'>
        <div><label>Turma</label><select class='input' id='c_turma'>${turmasOpts}</select></div>
        <div><label>Data</label><input class='input' id='c_data' type='date' value='${new Date().toISOString().slice(0,10)}'/></div>
        <div style='display: flex; align-items: flex-end;'><button class='btn primary' id='c_iniciar' style='width: 100%;'>‚ñ∂Ô∏è Iniciar</button></div>
      </div>
      <div id='c_body' style='margin-top:20px'></div>
    </div>
  `);
  setActiveNav('viewChamada');
  
  el('#c_iniciar').onclick = ()=>{
    const turmaId = el('#c_turma').value; const turma = db.turmas.find(x=>x.id===turmaId);
    const alunos = db.alunos.filter(a=>a.turma===turma.nome);
    const list = alunos.map(a=>`<label class='row' style='padding: 10px; background: var(--bg); border-radius: 8px; cursor: pointer;'><input type='checkbox' data-presente='${a.id}' checked style='margin-right: 10px;'/> ${a.nome} <span class='muted' style='margin-left: auto;'>(${a.matricula})</span></label>`).join('');
    el('#c_body').innerHTML = `
      <div class='card'>
        <h3>üìã ${turma.nome} ‚Äî Lista de Presen√ßa</h3>
        <div class='grid' style='margin-top: 16px;'>${list||'<div class="muted">Sem alunos nessa turma.</div>'}</div>
        <div class='row' style='margin-top:20px;'><button class='btn primary' id='c_salvar'>üíæ Salvar Chamada</button></div>
      </div>`;
    el('#c_salvar').onclick = ()=>{
      const presencas = alunos.map(a=>({alunoId:a.id, presente:!!document.querySelector(`[data-presente='${a.id}']`).checked}));
      const rec = {id:uid('ch'), turmaId, dataISO:new Date(el('#c_data').value).toISOString(), presencas};
      db.chamadas.push(rec); DB.set(db); toast('Chamada salva com sucesso!'); viewChamada();
    };
  };
  
  el('#btnHistoricoChamada').onclick = ()=>{
    const rows = db.chamadas.slice(-50).reverse().map(ch=>{
      const turma = db.turmas.find(t=>t.id===ch.turmaId); const presentes = ch.presencas.filter(p=>p.presente).length;
      return row([fmtDate(ch.dataISO), turma?turma.nome:'‚Äî', `${presentes}/${ch.presencas.length}`, `<button class='btn' data-exportch='${ch.id}'>üìÑ CSV</button>`]);
    }).join('');
    setView('Hist√≥rico de Chamadas','', tbl(row(['Data','Turma','Presentes','A√ß√µes'],true)+rows));
  };
}

function exportChamadaCSV(id){
  const db = DB.get(); const ch = db.chamadas.find(x=>x.id===id); if(!ch) return;
  const turma = db.turmas.find(t=>t.id===ch.turmaId);
  let csv = `Data,Turma,Aluno,Presente\n`;
  ch.presencas.forEach(p=>{
    const a = db.alunos.find(x=>x.id===p.alunoId);
    csv += `${fmtDate(ch.dataISO)},${turma?turma.nome:''},${a?a.nome:''},${p.presente?'Sim':'N√£o'}\n`;
  });
  const blob = new Blob([csv],{type:'text/csv'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`chamada_${turma?turma.nome:''}_${ch.dataISO.slice(0,10)}.csv`; a.click();
}

// Biblioteca
function viewBiblioteca(){
  const db = DB.get();
  const header = row(['ISBN','T√≠tulo','Autor','Cat.','Ex.','A√ß√µes'],true);
  const rows = db.livros.map(l=> row([l.isbn,l.titulo,l.autor,l.categoria,l.exemplares,
    `<div class='row' style="gap: 6px;">
      <button class='btn' data-emprest='${l.id}'>üì§ Emprestar</button>
      <button class='btn' data-editlivro='${l.id}'>‚úèÔ∏è Editar</button>
      <button class='btn danger' data-rmlivro='${l.id}'>üóëÔ∏è</button>
    </div>`
  ]) ).join('');
  const abertos = db.emprestimos.filter(e=>!e.devolvidoEm);
  const atrasados = abertos.filter(e=> new Date(e.devolverAte) < new Date());
  setView('Biblioteca', `<button class='btn primary' id='addLivro'>‚ûï Novo Livro</button> <span class='badge'>Em aberto: ${abertos.length}</span><span class='badge' style='border-color:#f59e0b;color:#fbbf24'>‚ö†Ô∏è Atrasos: ${atrasados.length}</span>`,
    tbl(header+rows)+
    `<div class='card' style='margin-top:20px'>
      <h3>üìö Empr√©stimos em aberto</h3>
      ${tbl(row(['Aluno','Livro','Retirado em','Devolver at√©','A√ß√µes'],true)+
        abertos.map(e=>{ const a = db.alunos.find(x=>x.id===e.alunoId); const l = db.livros.find(x=>x.id===e.livroId); return row([a?a.nome:'', l?l.titulo:'', fmtDate(e.retiradoEm), fmtDate(e.devolverAte), `<button class='btn primary' data-dev='${e.id}'>‚úÖ Devolver</button>`]); }).join('')
      )}
    </div>`
  );
  setActiveNav('viewBiblioteca');
}

function formLivro(l){
  const isNew = !l; l = l || {isbn:'', titulo:'', autor:'', categoria:'', exemplares:1};
  setView(isNew?'Novo Livro':'Editar Livro','',`
    <div class='card'>
      <div class='grid grid-3'>
        <div><label>ISBN</label><input class='input' id='lv_isbn' value='${l.isbn}'/></div>
        <div><label>T√≠tulo</label><input class='input' id='lv_titulo' value='${l.titulo}'/></div>
        <div><label>Autor</label><input class='input' id='lv_autor' value='${l.autor}'/></div>
        <div><label>Categoria</label><input class='input' id='lv_cat' value='${l.categoria}'/></div>
        <div><label>Exemplares</label><input class='input' id='lv_ex' type='number' value='${l.exemplares}'/></div>
      </div>
      <div class='row' style='margin-top:20px; gap: 12px;'>
        <button class='btn primary' id='saveLivro'>üíæ Salvar</button>
        <button class='btn' data-open='viewBiblioteca'>‚ùå Cancelar</button>
      </div>
    </div>
  `);
  el('#saveLivro').onclick = ()=>{
    const db = DB.get();
    const rec = {id:l.id||uid('l'), isbn:el('#lv_isbn').value.trim(), titulo:el('#lv_titulo').value.trim(), autor:el('#lv_autor').value.trim(), categoria:el('#lv_cat').value.trim(), exemplares:parseInt(el('#lv_ex').value,10)||1};
    if(!rec.titulo) return toast('Informe o t√≠tulo.');
    if(l.id){ const i=db.livros.findIndex(x=>x.id===l.id); db.livros[i]=rec; }
    else db.livros.push(rec);
    DB.set(db); viewBiblioteca(); renderKPIs();
  };
}

function formEmprestimo(l){
  const db = DB.get();
  const alunosOpts = db.alunos.map(a=>`<option value='${a.id}'>${a.nome} (${a.matricula})</option>`).join('');
  const hoje = new Date(); const devol = new Date(hoje.getTime()+ 7*24*60*60*1000);
  setView('Novo Empr√©stimo','',`
    <div class='card'>
      <div class='grid grid-3'>
        <div><label>Livro</label><input class='input' value='${l.titulo}' disabled/></div>
        <div><label>Aluno</label><select class='input' id='em_aluno'>${alunosOpts}</select></div>
        <div><label>Prazo</label><select class='input' id='em_prazo'>
          <option value='7' selected>7 dias</option>
          <option value='15'>15 dias</option>
          <option value='30'>30 dias</option>
        </select></div>
        <div><label>Devolver at√©</label><input class='input' id='em_devol' type='date' value='${devol.toISOString().slice(0,10)}'/></div>
      </div>
      <div class='row' style='margin-top:20px; gap: 12px;'>
        <button class='btn primary' id='saveEmp'>‚úÖ Confirmar</button>
        <button class='btn' data-open='viewBiblioteca'>‚ùå Cancelar</button>
      </div>
    </div>
  `);
  const selPrazo = el('#em_prazo'); if(selPrazo){ selPrazo.onchange=()=>{ const d=new Date(); d.setDate(d.getDate()+parseInt(selPrazo.value,10)); el('#em_devol').value=d.toISOString().slice(0,10); }; }
  el('#saveEmp').onclick = ()=>{
    const alunoId = el('#em_aluno').value; const devolverAte = new Date(el('#em_devol').value).toISOString();
    const rec = {id:uid('e'), alunoId, livroId:l.id, retiradoEm:nowISO(), devolverAte, devolvidoEm:null};
    db.emprestimos.push(rec); DB.set(db); toast('Empr√©stimo registrado!'); viewBiblioteca(); renderKPIs();
  };
}

function devolverEmprestimo(id){
  const db = DB.get(); const e = db.emprestimos.find(x=>x.id===id); if(!e) return;
  e.devolvidoEm = nowISO(); DB.set(db); toast('Devolu√ß√£o registrada!'); viewBiblioteca(); renderKPIs();
}

// Protocolos
function viewProtocolos(){
  const db = DB.get();
  const header = row(['N√∫mero','Assunto','Interessado','Status','Data','A√ß√µes'],true);
  const rows = db.protocolos.map(p=> row([p.numero,p.assunto,p.interessado,p.status,fmtDate(p.dataISO), `<button class='btn' data-editprot='${p.id}'>‚úèÔ∏è Editar</button>`]) ).join('');
  setView('Protocolos', `<button class='btn primary' id='addProt'>‚ûï Novo Protocolo</button>`, tbl(header+rows));
  setActiveNav('viewProtocolos');
}

function formProtocolo(p){
  const isNew = !p; p = p || {numero:('PR-'+String(Math.floor(Math.random()*9000+1000))), assunto:'', interessado:'', status:'Aberto', detalhes:''};
  setView(isNew?'Novo Protocolo':'Editar Protocolo','',`
    <div class='card'>
      <div class='grid grid-2'>
        <div><label>N√∫mero</label><input class='input' id='pr_num' value='${p.numero}'/></div>
        <div><label>Interessado</label><input class='input' id='pr_int' value='${p.interessado}'/></div>
        <div><label>Assunto</label><input class='input' id='pr_ass' value='${p.assunto}'/></div>
        <div><label>Status</label><select id='pr_st' class='input'>${['Aberto','Em an√°lise','Conclu√≠do','Arquivado'].map(s=>`<option ${p.status===s?'selected':''}>${s}</option>`)}</select></div>
      </div>
      <div><label>Detalhes</label><textarea class='input' id='pr_det' rows='4'>${p.detalhes||''}</textarea></div>
      <div class='row' style='margin-top:20px; gap: 12px;'>
        <button class='btn primary' id='saveProt'>üíæ Salvar</button>
        <button class='btn' data-open='viewProtocolos'>‚ùå Cancelar</button>
      </div>
    </div>
  `);
  el('#saveProt').onclick = ()=>{
    const db = DB.get();
    const rec = {id:p.id||uid('pr'), numero:el('#pr_num').value.trim(), interessado:el('#pr_int').value.trim(), assunto:el('#pr_ass').value.trim(), status:el('#pr_st').value, detalhes:el('#pr_det').value.trim(), dataISO: p.dataISO || nowISO()};
    if(p.id){ const i=db.protocolos.findIndex(x=>x.id===p.id); db.protocolos[i]=rec; } else db.protocolos.push(rec);
    DB.set(db); viewProtocolos();
  };
}

// Licen√ßas
function viewLicencas(){
  const db = DB.get();
  const header = row(['Professor','Tipo','In√≠cio','Fim','Dias','Motivo'], true);
  const rows = db.licencas.map(l=>{
    const p = db.professores.find(x=>x.id===l.profId);
    const dias = Math.max(1, Math.ceil((new Date(l.fim)-new Date(l.inicio))/(1000*60*60*24))+1);
    return row([p?p.nome:'', l.tipo, fmtDate(l.inicio), fmtDate(l.fim), dias, l.motivo||'‚Äî']);
  }).join('');
  setView('Licen√ßas de Professores', `<button class='btn primary' id='addLic'>‚ûï Nova Licen√ßa</button>`, tbl(header+rows));
  setActiveNav('viewLicencas');
}

function formLicenca(){
  const db = DB.get();
  const profOpts = db.professores.map(p=>`<option value='${p.id}'>${p.nome}</option>`).join('');
  setView('Nova Licen√ßa','',`
    <div class='card'>
      <div class='grid grid-3'>
        <div><label>Professor</label><select id='lc_prof' class='input'>${profOpts}</select></div>
        <div><label>Tipo</label><select id='lc_tipo' class='input'><option>Atestado</option><option>Licen√ßa m√©dica</option><option>F√©rias</option><option>Outros</option></select></div>
        <div><label>In√≠cio</label><input id='lc_inicio' class='input' type='date'/></div>
        <div><label>Fim</label><input id='lc_fim' class='input' type='date'/></div>
        <div><label>Motivo</label><input id='lc_motivo' class='input' placeholder='Opcional'/></div>
      </div>
      <div class='row' style='margin-top:20px; gap: 12px;'>
        <button class='btn primary' id='saveLic'>üíæ Salvar</button>
        <button class='btn' data-open='viewLicencas'>‚ùå Cancelar</button>
      </div>
    </div>
  `);
  el('#saveLic').onclick = ()=>{
    const rec = {id:uid('lc'), profId:el('#lc_prof').value, tipo:el('#lc_tipo').value, inicio:new Date(el('#lc_inicio').value).toISOString(), fim:new Date(el('#lc_fim').value).toISOString(), motivo:el('#lc_motivo').value.trim()};
    const db = DB.get(); db.licencas.push(rec); DB.set(db); viewLicencas();
  };
}

// Config
function viewConfig(){
  const db = DB.get();
  setView('Configura√ß√µes', '', `
    <div class='grid'>
      <div class='card'>
        <h3>üè´ Dados da Escola</h3>
        <div><label>Nome da escola</label><input class='input' id='cf_nome' value='${db.meta.schoolName}'/></div>
        <button class='btn primary' id='saveCfg' style='margin-top: 16px; width: 100%;'>üíæ Salvar Configura√ß√µes</button>
      </div>
      
      <div class='card'>
        <h3>üë• Usu√°rios</h3>
        <div id='cf_users' style='margin: 16px 0;'></div>
        <button class='btn' id='addUser' style='width: 100%;'>‚ûï Adicionar Usu√°rio</button>
      </div>
      
      <div class='card'>
        <h3>‚ö†Ô∏è Zona de Perigo</h3>
        <p class='muted' style='margin-bottom: 16px;'>Este sistema √© local (navegador). Para produ√ß√£o, use autentica√ß√£o do seu provedor e backend real.</p>
        <button class='btn danger' id='resetDB' style='width: 100%;'>üóëÔ∏è Zerar Banco (cuidado)</button>
      </div>
    </div>
  `);
  setActiveNav('viewConfig');
  
  const list = db.users.map(u=>`<div class='row between' style='padding:10px 0;border-bottom:1px solid var(--tile-border)'>
    <div>${u.name} <span class='badge'>${u.email}</span> <span class='badge'>${u.role}</span></div>
    <div class='row' style='gap: 6px;'>
      <button class='btn' data-edituser='${u.id}'>‚úèÔ∏è</button>
      <button class='btn danger' data-rmuser='${u.id}'>üóëÔ∏è</button>
    </div>
  </div>`).join('');
  el('#cf_users').innerHTML = list;

  el('#saveCfg').onclick = ()=>{
    db.meta.schoolName = el('#cf_nome').value.trim()||db.meta.schoolName;DB.set(db); el('#schoolName').textContent=db.meta.schoolName; toast('Configura√ß√µes salvas!');
  };
  el('#resetDB').onclick = ()=>{ if(confirm('Tem certeza que deseja zerar o banco e recriar dados de exemplo?')){ DB.reset(); ensureDB(); initAfterLogin(); toast('Banco reiniciado!'); } };
}

function formUser(u){
  const isNew = !u; u = u || {email:'', name:'', role:ROLES.SECRETARIA, pass:''};
  setView(isNew?'Novo Usu√°rio':'Editar Usu√°rio','',`
    <div class='card'>
      <div class='grid grid-2'>
        <div><label>Nome</label><input class='input' id='us_name' value='${u.name}'/></div>
        <div><label>Email</label><input class='input' id='us_email' value='${u.email}'/></div>
        <div><label>Fun√ß√£o</label><select id='us_role' class='input'>
          ${Object.values(ROLES).map(r=>`<option ${u.role===r?'selected':''}>${r}</option>`).join('')}
        </select></div>
        <div><label>Senha</label><input class='input' id='us_pass' type='password' placeholder='${isNew?"Digite a senha":"Deixe vazio para manter"}'/></div>
      </div>
      <div class='row' style='margin-top:20px; gap: 12px;'>
        <button class='btn primary' id='saveUser'>üíæ Salvar</button>
        <button class='btn' data-open='viewConfig'>‚ùå Cancelar</button>
      </div>
    </div>
  `);
  el('#saveUser').onclick = ()=>{
    const db = DB.get();
    const pass = el('#us_pass').value.trim();
    const rec = {id:u.id||uid('u'), email:el('#us_email').value.trim(), name:el('#us_name').value.trim(), role:el('#us_role').value, pass: pass||u.pass||'123'};
    if(!rec.email || !rec.name) return toast('Preencha email e nome.');
    if(u.id){ const i=db.users.findIndex(x=>x.id===u.id); db.users[i]=rec; }
    else db.users.push(rec);
    DB.set(db); viewConfig();
  };
}

// CSV Import
async function importCSV(file, kind){
  const text = await file.text();
  const lines = text.split(/\r?\n/).filter(x=>x.trim());
  if(lines.length<2) return toast('CSV vazio.');
  const headers = lines[0].split(',').map(h=>h.trim().toLowerCase());
  const db = DB.get();
  for(let i=1;i<lines.length;i++){
    const cols = lines[i].split(','); if(!cols.length) continue;
    const obj = Object.fromEntries(headers.map((h,idx)=>[h, (cols[idx]||'').trim()]));
    if(kind==='alunos'){
      db.alunos.push({id:uid('a'), matricula:obj.matricula||'', nome:obj.nome||'', turma:obj.turma||'', turno:obj.turno||'Manh√£'});
    }
  }
  DB.set(db); toast('Importa√ß√£o conclu√≠da!');
  if(kind==='alunos') viewAlunos();
}

// ===== ROUTER & EVENTS ====================================================
document.addEventListener('click', (e)=>{
  const b = e.target.closest('button'); if(!b) return;
  const open = b.dataset.open; if(open){
    ({viewDashboard,viewAlunos,viewProfessores,viewTurmas,viewChamada,viewBiblioteca,viewProtocolos,viewLicencas,viewConfig}[open])?.();
    return;
  }
  if(b.id==='addAluno') return formAluno();
  if(b.dataset.editaluno){ const db=DB.get(); formAluno(db.alunos.find(x=>x.id===b.dataset.editaluno)); return;}
  if(b.dataset.rmaluno){ const db=DB.get(); db.alunos=db.alunos.filter(x=>x.id!==b.dataset.rmaluno); DB.set(db); viewAlunos(); renderKPIs(); return;}

  if(b.id==='addProf') return formProf();
  if(b.dataset.editprof){ const db=DB.get(); formProf(db.professores.find(x=>x.id===b.dataset.editprof)); return;}
  if(b.dataset.rmprof){ const db=DB.get(); db.professores=db.professores.filter(x=>x.id!==b.dataset.rmprof); DB.set(db); viewProfessores(); renderKPIs(); return;}

  if(b.id==='addTurma') return formTurma();
  if(b.dataset.editturma){ const db=DB.get(); formTurma(db.turmas.find(x=>x.id===b.dataset.editturma)); return;}
  if(b.dataset.rmturma){ const db=DB.get(); db.turmas=db.turmas.filter(x=>x.id!==b.dataset.rmturma); DB.set(db); viewTurmas(); return;}

  if(b.id==='addLivro') return formLivro();
  if(b.dataset.editlivro){ const db=DB.get(); formLivro(db.livros.find(x=>x.id===b.dataset.editlivro)); return;}
  if(b.dataset.rmlivro){ const db=DB.get(); db.livros=db.livros.filter(x=>x.id!==b.dataset.rmlivro); DB.set(db); viewBiblioteca(); renderKPIs(); return;}
  if(b.dataset.emprest){ const db=DB.get(); formEmprestimo(db.livros.find(x=>x.id===b.dataset.emprest)); return;}
  if(b.dataset.dev){ devolverEmprestimo(b.dataset.dev); return;}

  if(b.id==='addProt') return formProtocolo();
  if(b.dataset.editprot){ const db=DB.get(); formProtocolo(db.protocolos.find(x=>x.id===b.dataset.editprot)); return;}

  if(b.id==='addLic') return formLicenca();

  if(b.id==='addUser') return formUser();
  if(b.dataset.edituser){ const db=DB.get(); formUser(db.users.find(x=>x.id===b.dataset.edituser)); return;}
  if(b.dataset.rmuser){ const db=DB.get(); db.users=db.users.filter(x=>x.id!==b.dataset.rmuser); DB.set(db); viewConfig(); return;}

  if(b.dataset.exportch){ exportChamadaCSV(b.dataset.exportch); return;}
});

// Top buttons
el('#btnExport').onclick = ()=>{
  const blob = new Blob([JSON.stringify(DB.get(), null, 2)], {type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='sma_backup.json'; a.click();
};

el('#importFile').addEventListener('change', (ev)=>{
  const f = ev.target.files[0]; if(!f) return; const r = new FileReader();
  r.onload = ()=>{ try { const data=JSON.parse(r.result); saveDB(data); initAfterLogin(); toast('Importado com sucesso!'); } catch(e){ toast('Arquivo inv√°lido.'); } };
  r.readAsText(f);
});

// Login events
el('#btnLogin').onclick = ()=>{
  const u = login(el('#loginEmail').value.trim(), el('#loginPass').value);
  if(!u) return toast('Credenciais inv√°lidas.');
  initAfterLogin();
};

el('#btnSeed').onclick = ()=>{ DB.reset(); ensureDB(); toast('Dados de exemplo recriados!'); };

el('#btnLogout').onclick = ()=>{
  logout();
  el('#app').classList.add('hidden');
  el('#login').classList.remove('hidden');
};

// Sidebar toggle
el('#toggleSidebar').onclick = ()=>{
  el('#sidebar').classList.toggle('collapsed');
  const icon = el('#toggleSidebar');
  icon.textContent = el('#sidebar').classList.contains('collapsed') ? '‚Ä∫' : '‚Äπ';
};

// Mobile menu
const mobileBtn = el('#mobileMenuBtn');
const sidebar = el('#sidebar');
const overlay = el('#sidebarOverlay');

if(window.innerWidth <= 768) {
  mobileBtn.style.display = 'flex';
}

mobileBtn.onclick = ()=>{
  sidebar.classList.toggle('open');
};

overlay.onclick = ()=>{
  sidebar.classList.remove('open');
};

window.addEventListener('resize', ()=>{
  if(window.innerWidth <= 768) {
    mobileBtn.style.display = 'flex';
  } else {
    mobileBtn.style.display = 'none';
    sidebar.classList.remove('open');
  }
});

function initAfterLogin(){
  const db = DB.get();
  el('#login').classList.add('hidden');
  el('#app').classList.remove('hidden');
  el('#schoolName').textContent = db.meta.schoolName;
  el('#userName').textContent = CURRENT_USER.name;
  el('#userRole').textContent = CURRENT_USER.role;
  el('#userAvatar').textContent = CURRENT_USER.name.charAt(0).toUpperCase();
  renderNav(); renderKPIs(); viewDashboard();
}

// App bootstrap
(function boot(){ ensureDB(); })();
  </script>
</body>
</html>